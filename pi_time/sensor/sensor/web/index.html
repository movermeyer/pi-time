<!DOCTYPE html>
<html>

<head>
    <title>Pi-time sensor</title>
    <script>
    AUTOBAHN_DEBUG = true;
    </script>
    <link rel='Stylesheet' href='sensor.css'>
    <script src='autobahn-0.9.2-2.js'></script>
    <script src='jquery-1.11.1.js'></script>
    <script src='knockout-3.2.0.js'></script>
    <script src='sammy-0.7.6.js'></script>
</head>

<body>
    <ul class='tabs' data-bind='foreach: tabs'>
        <li data-bind='text: $data, 
                     css: { selected: $data == $root.selectedTabId() },
                     click: $root.goToTab'></li>
    </ul>

    <div class='setup'>

    </div>

    <table class='events' data-bind='with: selectedTabData'>
        <thead>
            <tr>
                <th>Date</th>
            </tr>
        </thead>
        <tbody data-bind='foreach: events'>
            <tr>
                <td data-bind='text: date'></td>
            </tr>
        </tbody>
    </table>

    <script>
    function SensorViewModel() {
        // Data
        var self = this;
        self.tabs = ['Setup', 'Events'];
        self.selectedTabId = ko.observable();
        self.selectedTabData = ko.observable();

        // Behaviours    
        self.goToTab = function(tab) {
            location.hash = tab
        };

        // Client-side routes    
        Sammy(function() {
            this.get('#:tab', function() {
                self.selectedTabId(this.params.tab);
            });

            this.get('', function() {
                this.app.runRoute('get', '#Setup')
            });
        }).run();
    };

    ko.applyBindings(new SensorViewModel());
    </script>

    <script>
    // URL of WAMP Router (Crossbar.io)
    var wsuri;
    if (document.location.origin == 'file://') {
        wsuri = 'ws://127.0.0.1:8888/ws';

    } else {
        wsuri = (document.location.protocol === 'http:' ? 'ws:' : 'wss:') + '//' +
            document.location.host + '/ws';
    }

    // WAMP connection to Router
    var connection = new autobahn.Connection({
        url: wsuri,
        realm: 'pi-time'
    });

    // fired when connection is established and session attached
    connection.onopen = function(session, details) {

        console.log('Connected');

        function on_laptimerevent(args) {
            var laptimer = args[0];
            // TODO: laptimer contain details of status change of laptimer 
            // server (start/stop/error) or current lap (started/finished)
            console.log('on_laptimerevent() event received from laptimer ' + laptimer);
        }
        session.subscribe('io.github.si618.pi-time.onlaptimerevent', on_laptimerevent).then(
            function(sub) {
                console.log('Subscribed to topic: onlaptimerevent');
            },
            function(err) {
                console.log('Failed to subscribe to topic: onlaptimerevent', err);
            }
        );

        function on_sensorevent(args) {
            var sensor = args[0];
            var occured = args[1]
            console.log('on_sensorevent() event received from sensor ' + sensor);
        }
        session.subscribe('io.github.si618.pi-time.onsensorevent', on_sensorevent).then(
            function(sub) {
                console.log('Subscribed to topic: onsensorevent');
            },
            function(err) {
                console.log('Failed to subscribe to topic: onsensorevent', err);
            }
        );

        function getSensorSetup(args) {
            var hardware = args[0];
            var laptimerServer = args[1];
            var sensorPosition = args[2];
            var sendorConfig = args[3]
            console.log('Got sensor setup');
        }
        session.register('io.github.si618.pi-time.getSensorSetup', getSensorSetup).then(
            function(reg) {
                console.log('Registered procedure: getSensorSetup');
            },
            function(err) {
                console.log('Failed to register procedure: getSensorSetup', err);
            }
        );

        function getSensorEvents(args) {
            var sensor = args[0];
            var events = args[1];
            console.log('Got sensor events');
        }
        session.register('io.github.si618.pi-time.getSensorEvents', getSensorEvents).then(
            function(reg) {
                console.log('Registered procedure: getSensorEvents');
            },
            function(err) {
                console.log('Failed to register procedure: getSensorEvents', err);
            }
        );

        function setSensorSetup(setup) {
            session.call('io.github.si618.pi-time.setSensorSetup', [setup]).then(
                function(res) {
                    console.log("setSensorSetup() result:", res);
                },
                function(err) {
                    console.log("setSensorSetup() error:", err);
                }
            );
        }
    };

    // fired when connection was lost (or could not be established)
    connection.onclose = function(reason, details) {
        console.log('Connection lost: ' + reason);
    }

    connection.open();
    </script>

</body>

</html>
